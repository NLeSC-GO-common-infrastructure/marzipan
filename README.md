# Badges

| fair-software.nl recommendations | Badge |
|:-|:-:|
| [1. Code Repository](https://fair-software.nl/recommendations/repository) | [![GitHub](https://img.shields.io/github/last-commit/NLeSC-GO-common-infrastructure/marzipan)](https://img.shields.io/github/last-commit/NLeSC-GO-common-infrastructure/marzipan) |
| [2. License](https://fair-software.nl/recommendations/license) | [![License](https://img.shields.io/github/license/NLeSC-GO-common-infrastructure/marzipan)]((https://img.shields.io/github/license/NLeSC-GO-common-infrastructure/marzipan)) |
| [3. Community Registry](https://fair-software.nl/recommendations/registry) | [![Research Software Directory]()]() |
| [4. Enable Citation](https://fair-software.nl/recommendations/citation) | [![DOI]()]() |
| [5. Code Quality Checklist](https://fair-software.nl/recommendations/checklist) | [![CII Best Practices](https://bestpractices.coreinfrastructure.org/projects/3754/badge)](https://bestpractices.coreinfrastructure.org/projects/3754)  |


# marzipan
Automated (SURF HPC) OpenNebula instantiation and provisioning

marzipan consists of the core marzipan.py python [module][## Usage]  providing a high level interface to the (SURFsara) OpenNebula cloud, as well as an accompanying Docker framework providing a fully automated instantiation and provisioning environment.

## Usage
To make use of `marzipan` the user should clone this repository to their local system. From with the `Docker` subdirectory the `nlesc/marzipan` Docker image can be built by running
```bash
./build_marzipan.sh
```
which create the image with tag `latest`.

The docker framework can then be used to instantiate abd provision a cluster of VMs by running
```bash
./deployCluster.sh
```
from the root directory of the repository. The `root` and `ubuntu` user ssh keys generated for the cluster, as well as the `hosts.yaml` file enabling provisioning with the `emma` platform leveraging `ansible` are written to the `deployments` directory in a subfolder wiith the clusters name. They can be used to subsequently interact with the cluster.

We note that the user should modify the `ClusterConf.ini` file located in the `config` folder to mach their requirements, and that they may wissh to adapt the `opennebula_goera.tpl` file provided in the `templates` folder as well. This should be done before executing `.deployCluster.sh`.


## The marzipan OpenNebula interface

The core `marzipan.py` module (located in the `Marzipan` subfolder) provides the `one_interface` class. The class' methods provide a high level interface to set up a cluster of VMs on the (SURFsara) OpenNebula cloud.

`marzipan.py` can be imported, poviding access to the class methods, or run as a script to fully automatedly set up a cluster of VMs. `marzipan.py` also provides a high level class method `deploy_cluster()` which corresponds to the execution as a script.

`marzipan` is complemented by a `ClusterConf.ini` file (in `config`), where the user can set desired configuration values such as the number of nodes, the name of the VMs, the OpenNebula endpoint and their credentials. The repository includes a file `ClusterConf.ini.example` which can be appropriately modified and subsequently renamed.

Furthermore, the user should supply a template file specifying the desired VM configuration. An example, `opennebula_goera.tpl`, is provided in the `templates` subfolder of the repository. Please bear in mind, that the base image for the OS disk must be made available for the user (with the credentials being used) before executing `marzipan`.

Finally, the user can provide a public ssh key file for the `root` user to be included with the template. Alternatively, the ssh key can be supplied in the `ClusterConf.ini` file.
NOTE: if using the Docker framework, the use should refrain from, or take great care in, changing the settings relating to the ssh keys, as these are autogenerated during deployment.

When run as a script or by invoking the full deployment method `mazipan` will construct a VM template in OpenNebula, and deploy the requested number of VMs based on this template. `marzipan` will then monitor the deployment, only reporting successful execution when all VMs are in the `RUNNING` LCM_STATE. If this has failed to complete after 120 seconds marziopan will exit, notifying the user of failure.


## Reference/Documentation

[OpenNebula 5.2 Documentation for the XML-RPC API][http://docs.opennebula.io/5.2/integration/system_interfaces/api.html#actions-for-templates-management]

[PYONE bindings documentation][http://docs.opennebula.io/5.12/integration/system_interfaces/python.html]
